---
title: "第一次组会报告"
author: "周施远"
date: "`r Sys.Date()`"
output:
  html_document: default
  word_document: default
---

# Chapter 1.布拉格傀儡

## 1.1统计"傀儡"

在研究的过程中，我们会借助科学模型来帮助我们进行研究，这些科学模型不能用真假来进行形容，但是它们在帮助我们达成某些研究目的时可以起到很大的作用。 例如我们在统计学研究中就会根据不同的情况来选择不同的统计模型来进行研究，如下图的决策树所示：

![](1.jpg)

正如上文所说，统计模型可以为我们提供宝贵的信息，但也会导致我们误入歧途。我们需要认识到传统统计工具的使用都是具有很多的前提假设的，但这些前提假设在我们实际使用统计模型的过程中经常会被我们所忽视。因此我们有必要对我们所学过的统计内容进行反思，使得统计工具变成我们应对问题的策略而非简单套用的工具。

## 1.2统计反思

我们需要正确地去认识统计模型与研究假设（区别于假设检验中的H0）之间的关系，与传统认知不同，本书作者认为仅仅利用统计模型的结果就去证伪某一研究假设时不合理的（这一证伪过程需要一整套的科学方法），主要原因有以下几点：

(1)研究假设并非模型。假设与模型之间的关系是错综复杂的而非一一对应的，因此用模型的证伪去得出研究假设的证伪是不合理的。

![](2.jpg)

以上图为例，已知H0和H1均正确，如果我们通过统计模型m2去检验研究假设的正确，无论我们是否拒绝m2，我们都会错误地拒绝掉H0或H1中的一个。

(2)测量非常重要，但我们的测量实际上是经常存在问题的。这体现在以下几点：1我们可用反例进行证伪，但不可用它们证实。但问题在于找到一个人们公认的反例大部分情况下很困难。 2测量误差是常态而非个例，我们很难完全避免其对于我们研究的影响。

## 1.3本书重点介绍的一些统计工具

(1)贝叶斯数据分析

贝叶斯学派与传统频率学派数据分析的最大区别在于贝叶斯否认了频率学派认为世界是随机的观点，转而认为随机只是信息的一种特质。而这一观点帮助贝叶斯数据分析在一些问题的解决上获得了独特的优势。

(2)模型比较与预测

在对不同模型进行比较时，优先考虑它们的预测精度是一个较好的选择。而在这其中，作者重点强调了交叉验证（包括保留，k折，留一法等）以及信息准则（AIC等）。

(3)多层次模型

作者认为一些模型中的参数本身就可以引申出一个新的模型，从而形成多层次模型，其最大的优点在于给我们提供了一条解决过拟合的有效路径。它还有以下的优点：

1修正重抽样中重复样本可能会给我们带来的问题

2修正重抽样中抽样不均衡可能会给我们带来的问题

3帮助我们研究总体中不同群体之间的差异

4避免数据标准化后我们对模型的评价虚高的问题

(4)因果模型

大部分的统计模型仅仅对事物之间的相关关系进行了研究，而无法对因果关系进行推断（尽管有时候正确的因果关系并不能帮助我们提升预测精度）。因果模型，例如有向非循环图（DIRECTED ACYCLIC GRAPH, DAG）可以帮助我们去认识事物之间因果关系，但是遗憾的是这一模型需要很多样本数据之外的信息，这也警示我们在进行科学研究时不能迷信数据和统计模型。

# Chapter 2.小世界与大世界

在统计研究中，小世界和大世界可以类比统计中的模型与现实。我们可以基于我们对于现实的认识来构造一个模型，这个模型可以帮助我们更好地认识现实，但是值得注意的是在模型中行得通的结论在现实中可能是错误的。

而贝叶斯模型有着独到的优势，它能够更充分地利用模型的信息，而在本章中我们也会重点去认识和学习贝叶斯模型。

## 2.1 分叉数据的花园

### 2.1.1 计算可能性

考虑下面的这种情况，布袋中有四个或蓝或白的球（除颜色外完全相同），则这四个球的组合有以下五种推测：

(1)[白白白白]；

(2)[蓝白白白]；

(3)[蓝蓝白白]；

(4)[蓝蓝蓝白]；

(5)[蓝蓝蓝蓝]；

现在我们进行有放回的摸球，摸球的结果依次为[蓝 白 蓝]，则我们有如下图所示的分析过程：

![](3.jpg)

以第二个推测为例，第一个摸出的球是蓝球，则只有摸出蓝球1这一可能的路径，第二个摸出的球是白球，则有白球1、白球2和白球3这三条可能的路径，第三个摸出的是蓝球，则也只有摸出蓝球1这一可能的路径。综上，共有$1*3*1=3$条可能的路径。由于[蓝蓝蓝白]对应的可能的路径最多，我们认为这个推测是更有可能的

### 2.1.2 利用先验信息

假设在2.1.1的基础上，我们又进行了一次摸球，结果为蓝球，那么就可以将2.1.1中得到的信息作为先验信息，来帮助我们判断各个推测是更有可能的，如下图所示：

![](4.jpg)

类比2.1.1的推理过程，由于[蓝蓝蓝白]对应的可能的路径最多，我们认为这个推测是更有可能的。

### 2.1.3 从计数到概率

$$
\begin{aligned}
&观察到[蓝白蓝]的情况下[蓝白白白]成立的可能性\\
&~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\propto\\
&在[蓝白白白]的假设下得到[蓝白蓝]的方式数目\\
&~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\times\\
&~~~~~~~~~~~~~~~~~~~~~~[蓝白白白]的先验可能性\\
\end{aligned}
$$

将袋中蓝色大理石的比例定义为p，对于【蓝白白白】的情况，$p=\frac{1}{4}=0.25$，将观测定义为$D_{new}$=[蓝白蓝]，这样一来就有如下的数学表达式：

$$ 观测到D_{new}情况下p成立的可能性=在p的假设下得到D_{new}的方式数目* p的先验概率$$

上面的表达式意味着对于任何的p值，我们认为其成立的可能性正比于在该p取值的情况下路径花园对应的路径的数目。

最后，我们将计算出的这些可能性标准化到[0,1]区间上得到相应的概率值，标准化后，所有假设的可能性取值相加为1。

$$ 观测到D_{new}情况下p成立的可能性=\frac{在p的假设下得到D_{new}的路径数目* p的先验概率}{所有p对应的乘积之和}$$

我们用定义的p和'可能性'更新2.1.1中的表格如下所示：

![](5.jpg)

**注：比如 0.15 = (3 \* 0.2) / (0 \* 0.2 + 3 \* 0.2 + 8 \* 0.2 + 9 \* 0.2 + 0 \* 0.2 )，其中，0.2表示蓝色大理石的比例p为0.25时的先验概率，由于这里假设所有情况都是一样的，所以每种情况的先验概率都是0.2**

以上所述每一步计算都存在对应的应用概率理论的定义：

(1)假定蓝色大理石的比例P通常称为参数值。

(2)每个p的取值对应的产生数据的路径数目通常称为似然值。

(3)关于p的先验可能性通常称为先验概率。

(4)在特定p取值情况下，根据样本观测更新后的可能性取值称为后验概率。

## 2.2 建立模型

假设你手中有一个地球，你想估计地球被陆地和水覆盖的比例分别是多少。你进行了下面的实验，将地球抛在空中，然后接到手中，记录地球最上面的那一点是陆地(L)还是水(W)。你把这个实验重复了9次，得到了如下结果：

$$W  ~~L ~~ W ~~ W ~  ~W  ~ ~L  ~~W  ~~L  ~~ W$$

### 2.2.1 数据的故事

贝叶斯数据分析往往意味着生成一个关于当前数据是怎么生成的的故事。即我们是怎样完成一次试验的，怎么收集我们观测数据的。比如在我们上述例子中，我们做出了以下假设：

（1）地球实际被水覆盖的比例为p；

（2）每一次投掷试验都有p的可能性生成一个观测water(w),有1-p的可能性生成一个观测land(L)；

（3）每次投掷都是独立的。

### 2.2.1 贝叶斯更新

我们的目的是根据现有的观测来推测地球表面被水覆盖的比例。Bayes模型开始于一系列的先验概率，然后根据我们实时观测结果来产生后验概率，后验概率又可以作为下一次实验的先验概率，以此进行，即贝叶斯更新。

首先由于我们没有任何关于p的信息，因此我们暂时认为p服从0到1上的均匀分布，然后我们利用几个观测的结果依次对贝叶斯模型进行更新，结果如下图所示：

![](https://s4.ax1x.com/2022/02/10/HNBgoR.png)

对于图上任一点，X轴坐标表示该点对应的p的取值，Y轴坐标则表示的是该点所取p值对应的可能性，虚线则表示本次试验的先验概率，实线则表示本次实验的后验概率，上一次试验的后验概率即本次试验的先验概率。值得注意是每一次W观测都将导致曲线右偏，L观测将导致曲线左偏。而曲线最高点高度不断上升意味着少部分p值对应的可能性随着样本的增加在不断上升。

注意：相较于非贝叶斯统计的良好表现往往建立在大样本的假设而言，贝叶斯统计对于任意大小的样本均有意义，但是贝叶斯统计依赖于初试可能性（先验概率），两种方法各有其特点。

### 2.2.3 评估

如果模型中对大世界的描述是准确的，那么Bayes推断通常是最优的解决方案。但是对模型结果的评价和核查依旧是不可缺少的。如果模型和现实存在很大差异，那么模型的适用性就应当让人怀疑。即便是模型和现实符合的很好，也至少需要注意下面两个原则。

（1）模型的确定性并不能保证模型是一个好模型。比如上面的例子，随着地球投掷次数增大，曲线范围会变得越来越窄，那么地球被水覆盖的比例变得确定性越来越高。但是，我们并不能保证这就是一个真实的情况，我们的推测都是建立在模型基础上的，我们不能保证选择的模型是一个好模型，换一个模型，可能得到不同的推论。比如，我们用的地球模型不能正确反映真实的海洋覆盖率，那么模型得到的确定性再高也没有意义。

（2）对模型进行检查评估是很重要的。在上面的例子中，9次试验的都是独立的，和试验顺序没有关系。所以不管你怎么投掷，只要是6次水3次陆地，最后的结果总是一样的。但是，如果试验之间不是独立的，那么就会得到完全不一致的结果。

## 2.3 模型的组成

### 2.3.1 变量

变量是就是一些可以取不同值的符号。本书中将变量分为可观测变量和不可观测变量（PARAMETRES即参数），例如上文中地球被水覆盖的比例p即为一个不可观测变量。我们可以通过可观测变量来推导不可观测变量。


### 2.3.2 一些定义

#### 2.3.2.1 可观测变量


似然函数（LIKELIHOOD）：指的是一个可观测变量的分布函数。

在上面掷地球的例子中，我们假设了每次实验都是独立的，同时每次投掷得到W的概率都相等，也就是一个我们了解的典型的二项分布模型。在这种情况下，地球被水覆盖的比例为p时，投掷n次地球，可以观测到w次海洋的概率为：

$$Pr(W|N,p)=\frac{N!}{W!(N-W)!}p^W(1-p)^{N-W}$$

在R语言中，可以通过dbinom函数来计算概率。

```{r}
dbinom(6, size = 9, prob = 0.5)
```

#### 2.3.2.2 不可观测变量

我们赋予可观测变量的分布函数中也有属于分布函数自己的变量，在上面的二项分布中就是p。

在Bayes模型中，每一个需要估计的参数都要有一个先验概率（prior）。

在上面掷地球的例子中，前一个试验的后验概率变为了后一个试验的前验概率，但是最关键的问题在于第一个试验的前验概率从何而来？很多时候是以人的信念为先验概率(SUBJECTIVE BAYESIAN)，比如上面提到的例子中所有的先验概率都一样。这也是我们在没有任何先验信息可用的情况下，常常使用的策略。这种先验概率通常被认为是弱信息先验概率，不过依旧很有用，很多非Bayes统计模型也使用了类似的策略。

### 2.3.3 构造模型

还是以掷地球为例，本例中一共涉及到4个变量：N（抛掷的总次数），W（水朝上的次数），L（陆地朝上的次数），p
（地球实际被水覆盖的比例，未知参数）。其中N=W+L。我们可以构造以下两个模型。
$$W\sim Binomial(N,p)$$
$$p\sim Uniform(0,1)$$
注意到此处我们给p赋予了一个从0到1均匀分布的先验概率，但这显然并不是一个好的选择。

## 2.4 运行模型

### 2.4.1 贝叶斯理论
对于每一个数据，似然函数，参数以及前验概率的独特组合而言，我们都可以得出一个独特的后验函数。以掷地球试验为例，后验概率实际上可以用以下表达式进行表示：
$$Pr(p|W,L)$$
要推导出这个公式，我们首先对条件概率公式和贝叶斯公式进行简单的复习。
$$Pr(W,L,p)=Pr(W,L|p)Pr(p)$$
$$Pr(W,L,p)=Pr(p|W,L)Pr(W,L)$$
$$Pr(W,L|p)*Pr(p)=Pr(p|W,L)Pr(W,L)$$
通过上面三个公式，我们可以推导出著名的贝叶斯公式，如下所示：
$$Pr(p|W,L)=\frac{Pr(W,L|p)Pr(p)}{Pr(W,L)}$$
将上述公式放在更一般的条件下，即可得到后验概率的推导公式：
$$后验=\frac{似然函数 \times 先验}{平均似然}$$ 
其中平均似然指的是利用先验对似然函数进行平均后的所得到的，可以用以下公式进行表示：
$$Pr(W,L)=E(Pr(W,L|p))=\int Pr(W,L|p)Pr(r)dp$$
接下来看贝叶斯公式在掷地球实验中的实际应用，如下图所示：

![](https://s4.ax1x.com/2022/02/10/HNBxl8.png)

x轴表示的是地球上被水覆盖的比例p,y轴表示的是可能性，此处的似然函数是我们在上文中通过9次试验得到的，我们可以看到在似然函数相同，先验不同的情况下，我们得到的后验也有所差异。

### 2.4.2 数值模拟方法

对于电脑而言，它虽然不能理解贝叶斯理论的公式，但是会采用数值模拟的方法来对后验进行求解，主要有以下三种方法：

（1）网格逼近（Grid approximation）

（2）二项逼近（Quadratic approximation）

（3）马尔科夫链蒙特卡罗方法(MCMC)

接下来主要对三种方法进行介绍：

### 2.4.3 网格逼近

1.定义

对于每个参数取值p',我们只需要计算后验概率，即将p'对应的先验概率乘以p'对应的似然函数值。在每个网格上取一个参数值计算相应的后验概率就能够大致逼近后验分布，这个过程就叫做网格逼近。

2.对模型进行网格逼近的步骤

1)定义网格。意味着需要用多个点来近似后验分布，然后将参数区域分成相应数目的网格选取参数值。

2)对每个参数值计算先验概率。

3)对每个参数值计算似然函数值。

4)将每个参数对应的先验概率乘以似然函数值得到没有标准化的后验概率。

5)最后通过除以所有后验概率取值的和对后验概率分布进行标准化。

以投掷球为例，用R代码实现以上5个步骤：

```{r}
#定义网格
p_grid<-seq(from=0,to=1,length.out=20) #生成从0-1之间间隔相同的20个数
head(p_grid)
```

定义先验分布$Pr(p)$

```{r}
prior<-rep(1,20)#将1重复20遍
```

计算网格每个参数取值对应的似然函数$Pr(w|p)$

```{r}
likelihood<-dbinom(6,size=9,prob=p_grid)#在每次给定概率取值的情况下，投掷9次，观测到6次水面的概率
head(likelihood)
```

计算似然函数和先验概率的乘积$Pr(w|p)Pr(p)$

```{r}
unstd.posterior<-likelihood*prior
head(unstd.posterior)
```

对后验概率进行标准化，标准化后概率之和为1 $$Pr(p|w)=\frac{Pr(w|p)Pr(p)}{Pr(w)}$$

```{r}
posterior<-unstd.posterior/sum(unstd.posterior)
head(posterior)
```

3.绘制得到的后验分布

mtext(as.character(i),side=j,line=i,outer=FALSE)\#mtext默认为outer=FALSE即在内边界注释文本，line表示与图像区域的距离(行高)

```{r}
plot(p_grid,posterior,type="b",xlab="水域覆盖面积",ylab="后验分布概率")
mtext("20个取值")
```

我们这儿只是使用了一个20个点的网格，你可以尝试使用不同大小的网格，网格越小，意味着你得到的结果越精确。

### 2.4.2 二项逼近（高斯逼近）

网格逼近有一个缺点，如果你的模型中有多个参数，那么你的计算量会成倍增长。比如有两个参数，每个都有100个网格，那么最终你要估计10000次。这个时候就体现出二项逼近的作用了。

一般情况下，后验概率的分布在分布的尖峰处会呈现出近正态分布。也就是说后验概率分布可以用正态分布来估计。我们知道正态分布很简单，只有两个参数就够了：位置参数（均值）和形状参数（方差）。正态分布类似抛物线，一个二次函数就可以描述，所以称之为平方估计。二项逼近准确度很高，同时对计算的要求又不像网格逼近或者MCMC那么高。

对模型进行二项逼近的步骤：

1)寻找后验众数。通常是通过最优算法寻找分布的"顶峰"。

2)找到后验分布的峰顶，估计峰顶的曲率。

```{r}
library(rethinking)
# 构建模型
globe.qa <- map(
  alist(w ~ dbinom(9,p), # 二项分布的似然率
  p ~ dunif(0,1)), # 均一分布的先验概率
  data = list(w=6) # 观测到6次海洋
)

# 显示二项逼近的结果
precis(globe.qa)
```

通过上面的平方估计，可以看到p=0.67，标准差为0.16，也就是后验概率分布的标准差，89%的分布区间为0.42-0.92。我们将得到的这个正态分布与实际的后验概率分布作比较如下：

![](https://s4.ax1x.com/2022/02/10/HNDAf0.png)

图中黑线是确切后验概率分布，蓝线是通过二项逼近得到的后验概率分布，随着实验次数(n)的增加，蓝线分布越来越接近实际后验概率分布。这也证明了二项逼近的准确性。

### 2.4.5 马尔科夫链蒙特卡罗方法

为什么要用马尔科夫链蒙特卡罗方法？对于参数量较大的模型而言。网格法的计算量非常大，耗费的时间过长；二项逼近容易出错（海森矩阵不正定），并且有时候后验分布的具体形式也不好表达，目标函数未知。

马尔科夫链蒙特卡罗方法通过模拟的方式对高维积分进行计算，进而使原本异常复杂的高维积分计算问题迎刃而解，使贝叶斯方法仅适用于解决简单低维问题的状况大有改观为贝叶斯方法的应用开辟了新的道路。但是它不是直接对后验分布进行模拟，而仅仅是从后验中抽取一些样本。本章中不会对该方法进行重点介绍，而会在第九章中结合实例详细说明，以下是用马尔科夫链蒙特卡罗方法模拟掷地球试验的代码：
```{r}
library(rethinking)
n_samples <- 1000
p <- rep( NA , n_samples )
p[1] <- 0.5
W <- 6
L <- 3
for ( i in 2:n_samples ) {
p_new <- rnorm( 1 , p[i-1] , 0.1 )
if ( p_new < 0 ) p_new <- abs( p_new )
if ( p_new > 1 ) p_new <- 2 - p_new
q0 <- dbinom( W , W+L , p[i-1] )
q1 <- dbinom( W , W+L , p_new )
p[i] <- ifelse( runif(1) < q1/q0 , p_new , p[i-1] )
}#此处的p即是从后验中抽取的一些样本#
dens( p , xlim=c(0,1) )
curve( dbeta( x , W+1 , L+1 ) , lty=2 , add=TRUE )
#可以看到我们得到的结果虽然比较奇怪，但仍然有效#
```

## 2.5 总结

贝叶斯推断的目标------>后验概率分布

后验概率--------> 介绍了基于现有数据的不同推测的可能性大小

贝叶斯模型------->由一系列变量及它们的分布信息组成

似然（也可称为数据的概率）------->在已知模型参数值的基础上，给出某个观测的可能性大小

先验------>在考虑数据的影响之前，给出参数每一个可能取值的可能性大小

# Chapter 3 想象中的采样

本章开头作者引用了一个利用贝叶斯公式调查吸血鬼的案例，向我们展示了统计方法虽然有用，但面对低质量数据或极端样本时也是比较无力的。此处仅展示代码部分：

```{r}
Pr_Positive_Vampire <- 0.95#吸血鬼被测出阳性的概率
Pr_Positive_Mortal <- 0.01#人类被测出阳性的概率
Pr_Vampire <- 0.001#吸血鬼占总体的比例
Pr_Positive <- Pr_Positive_Vampire * Pr_Vampire +
Pr_Positive_Mortal * ( 1 - Pr_Vampire )
( Pr_Vampire_Positive <- Pr_Positive_Vampire*Pr_Vampire / Pr_Positive )#计算阳性个体中吸血鬼的比例
```

## 3.1 从网格逼近法得到的后验中抽样

我们就掷地球试验进行研究，网格逼近法得到的后验中抽取10000个样本，并绘制出这些样本的散点图和密度曲线，具体如下所示：

```{r}
p_grid <- seq( from=0 , to=1 , length.out=1000 )
prob_p <- rep( 1 , 1000 )
prob_data <- dbinom( 6 , size=9 , prob=p_grid )
posterior <- prob_data * prob_p
posterior <- posterior / sum(posterior)
samples <- sample( p_grid , prob=posterior , size=1e4 , replace=TRUE )
plot(samples)
library(rethinking)
dens(samples)
```

以上步骤虽然仅仅是重复了我们在前一章中进行的计算并绘制了图表，但是它们可以帮助我们更好地理解后验分布。

## 3.2 抽样总结

### 3.2.1 通过边界来定义的区间

在后验中，我们可以通过一个确定的边界来找到对应的区间。例如在掷地球实验中，我们可以通过给定p值的一个取值范围，从而得到这个范围在后验中对应的总可能性。代码如下：

```{r}
sum(posterior[p_grid<0.5])
```
由于在计算机中，后验是通过样本数值模拟的方法得出的，因此我们也可以通过给定样本取值的一个区间，从而得到这个范围在后验中对应的总可能性。

```{r}
sum(samples<0.5)/1e4
```

### 3.2.2 通过比重来定义的区间

在频率学派的研究中，置信区间(CONFIDENCE INTERVAL)是通过比重来定义的区间的典型代表，它代表所有样本中比例为$1-\alpha$的样本将会落在该区间中。而在贝叶斯统计中，可将置信区间类比为后验概率的一个可信区间(CREDIBLE INTERVAL),它由两个参数值构成，而这两个参数值构成的区间中包含了值为$1-\alpha$的后验概率。而本书为了避免混淆置信区间和可信区间，采用兼容性区间(COMPATIBILITY INTERVAL)来替代可信区间。

本书作者给出了一些利用r语言来求解兼容性区间的代码，值得注意是利用后验中的样本来构造这些区间要比用网格逼近法构造要简单

仍然是以掷地球实验为例。利用后验中的样本来构造兼容性区间

```{r}
quantile(samples,0.8)#获取一个从p=0开始，总后验概率为0.8的兼容性区间的右端点
```
特别的，对于双尾概率相等的兼容性区间，我们将它命名为分位数区间（percentile intervals,简称为PI）,当后验概率分布比较对称时，PI的效果较好。代码实现如下面所示。

```{r}
quantile(samples, c(0.1,0.9))
```

![](6.png)
但是当后验概率分布不对称时，PI会影响我们的正确判断。考虑掷地球实验中我们进行了3次实验，实验结果均为水朝上，此时我们再观察PI的效果，代码实现如下：

```{r}
p_grid <- seq( from=0 , to=1 , length.out=1000 )
prior <- rep(1,1000)
likelihood <- dbinom( 3 , size=3 , prob=p_grid )
posterior <- likelihood * prior
posterior <- posterior / sum(posterior)
samples <- sample( p_grid , size=1e4 , replace=TRUE , prob=posterior )
PI( samples , prob=0.5 )
```
![](8.png)

显而易见该区间甚至没有把可能性最大的p=1包括进去，可见估计效果较差。此时我们引入另一种区间取法：最大后验密度区间（HIGHEST POSTERIOR DENSITY INTERVAL,简称为HDPI）,对于某个特定的概率比重而言，HDPI的区间长度是最短的，代码实现如下图所示：

```{r}
HPDI( samples , prob=0.5 )
```
但是值得注意的是HDPI对于抽样量很敏感，样本量小时效果较差。

总而言之，如果我们使用两种区间估计的结果出入较大时，我们尽量应该试图画出后验分布的完整分布，而非用兼容性区间进行估计。

### 3.2.3 点估计

我们在贝叶斯估计中如果要进行点估计，则很自然地我们会选择一个拥有最高后验概率的参数估计值即最大后验估计（maximum a posteriori, MAP）。还是以掷地球实验为例，假设我们投掷三次得到了三次水。我们可以用电脑得到这一估计，代码如下：

```{r}
 p_grid[ which.max(posterior) ]
```
![](7.png)

问题在于我们为什么要选择这一点估计，而非后验均值或后验中位数？

此时我们就要引入一个新的概念：损失函数（LOSS FUNCTION）。损失函数是用来形容选择某一点估计的代价的准则，它实质上和点估计与参数真值的距离成比例。

仍然采用上面的掷地球实验为例，假设我们取p=0.5作为我们的点估计，则对于我们通过模拟得到的后验而言，损失函数可以用以下的代码进行计算：
```{r}
sum( posterior*abs( 0.5 - p_grid ) )
```
此处的后验概率实际上是在对每一个样本点的损失进行加权。

而实际上如果我们要对一系列点估计依据它们的损失函数进行比较的话，我们可以使用sapply（）函数进行简化，选择损失函数最小的点估计，代码如下：

```{r}
loss <- sapply( p_grid , function(d) sum( posterior*abs( d - p_grid ) ) )
p_grid[ which.min(loss) ]
```
此时我们可以依据损失函数来选择0.84作为p的点估计，这也正是后验中位数。

需要注意的是损失函数的不同形式也会导致不同的点估计结果，上文中损失函数采用了｜d-p｜的形式后确定了后验中位数为点估计，但如果损失函数采用（d-p）^2的形式，我们则会认为后验均值才是比较好的结果。

## 3.3 抽样预测

后验分布样本的另外一个常见功能是为我们提供一个了解当前模型可能产生什么样本的简单方法，本章的最后一节将介绍如何模拟样本以及进行一些简单的模型评估。

### 3.3.1 虚拟数据

现在对这两个章节一直使用的投掷球模型进行总结。

首先，水域覆盖率P是存在且固定的，该值是我们想要估计的，将球投掷后得到观测，得到"水面"的概率是p，得到"陆地"的概率是 1-p

这些假设不仅让我们获得观测的情况下推断每个P取值的可能性，还让我们能够从后验分布中模拟模型可能产生的样本，这是因为给定观测，似然函数能够告诉你得到该观测的似然值，如果给定参数，似然函数定义了观测值的分布，可以根据该分布模拟可能的观测值。我们将这些模拟的数据称为**虚拟数据**，说明这不是真实的观测数据，而是一种近似或者模拟

在投掷球模型中，虚拟数据来自如下的二项似然函数：

$$ Pr(W|N, p) = \frac{N!}{W!(N-W)!}p^W(1-p)^{N-W}$$ 其中w是观测到水面的次数，n是总投掷次数。假设n=2，一共投了2次球，那么观测的水面的次数可能取值只有3个：0次，1次和2次。给定P的值，你能很容易计算出每个观测对应的似然函数。

假设P=0.7，该值大概是真是的地球表面海洋覆盖率：

```{r}
dbinom(0:2 , size = 2,prob = 0.7)
```

这意味着w=0的概率为9%，w=1的概率为42%，w=2的概率为49%。

现在，我们通过这些似然值来模拟观测，可以用rbinom()函数来实现，这里生成10个样本：

```{r}
dummy_w <- rbinom(10,size = 2,prob = 0.7)
table(dummy_w)/10
```

现在，生成100 000个虚拟数据，检查下每个观测出现的频率是否与相应的似然值成比例：

```{r}
dummy_w1 <- rbinom(1e5,size = 2,prob = 0.7)
table(dummy_w1)/1e5
```

这些取值和之前计算的理论似然值非常相近，由于抽样的随机性，他们可能并不完全相等。

只执行2次貌似不够，现在假设一共投掷了9次，同样模拟100 000个观测：

```{r}
dummy_w2 <- rbinom(1e5,size = 9,prob = 0.7)
simplehist(dummy_w2,xlab='dummy water count')
```

![](https://s4.ax1x.com/2022/02/10/HNsYee.png)

以上就是如何进行最基本的样本模拟

### 3.3.2 模型检查

模型不可能完美，因此我们要有自己的判断和取舍，现在，我们结合模拟观测（上一节讲到的）并通过后验分布模拟参数取值。

首先，观测具有不确定性。预测的样本具有不确定性，因为即使你确切的知道了P的取值，也不能知道下一次投球的结果（除非p=0或p=1)

其次，p的取值具有不确定性。这种不确定性体现了在后验分布中，由于P具有不确定性，于是一切与P有关的也具有不确定性。

于是，从模型中得到的预测包括了两种不确定性：**观测的不确定性和参数取值的不确定性**。

接着，我们将参数的取值的不确定性代入预测。这里要做的只是将不同取值的P对应的预测分布在P的后验分布上取平均。每个P对应一个观测的分布，计算出该样本分布后，你可以找到这个P取值对应的后验分布概率，然后用后验分布概率加权取平均，得到**后验预测分布**。

下图给出了这一加权的过程。

（1）图的上部是参数的后验分布，垂直标注的是10个不同的参数取值；

（2）每个参数取值对应的观测样本分布是中间那行条形图（也就是上一节中讲到的）；

（3）最后，在图的最底部，我们将所有p取值通过后验概率结合起来，计算得到没和可能观测的加权平均频率。

![](https://s4.ax1x.com/2022/02/10/HNsry8.png) 
